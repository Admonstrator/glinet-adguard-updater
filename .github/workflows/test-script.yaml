name: Test Update Script

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'update-adguardhome.sh'
      - '.github/workflows/test-script.yaml'
  pull_request:
    branches: [ main ]
    paths:
      - 'update-adguardhome.sh'
      - '.github/workflows/test-script.yaml'

jobs:
  shellcheck:
    name: ShellCheck Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          format: gcc
          severity: warning
          additional_files: 'update-adguardhome.sh'

  syntax-check:
    name: Syntax Validation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shell: [dash, bash, sh]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shells
        run: |
          sudo apt-get update
          sudo apt-get install -y dash

      - name: Check syntax with ${{ matrix.shell }}
        run: |
          ${{ matrix.shell }} -n update-adguardhome.sh

  flag-tests:
    name: Flag Parsing Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test --ignore-free-space flag
        run: |
          # Test that script recognizes the flag
          output=$(sh update-adguardhome.sh --ignore-free-space 2>&1 <<< 'n' || true)
          if echo "$output" | grep -q "\-\-ignore-free-space is used"; then
            echo "✓ --ignore-free-space flag works correctly"
          else
            echo "❌ --ignore-free-space flag not recognized"
            exit 1
          fi

      - name: Test --select-release flag
        run: |
          # Test that script recognizes the flag
          timeout 10 sh -c 'echo "1" | sh update-adguardhome.sh --select-release 2>&1' || true | tee output.log
          if grep -q "Available release labels\|Fetching available release labels" output.log; then
            echo "✓ --select-release flag works correctly"
          else
            echo "⚠️  --select-release flag may need internet connection"
          fi

      - name: Test version output
        run: |
          version=$(grep 'SCRIPT_VERSION=' update-adguardhome.sh | head -1 | cut -d'"' -f2)
          echo "Script version: $version"
          [[ "$version" =~ ^[0-9]{4}\.[0-9]{2}\.[0-9]{2}\.[0-9]{2}$ ]] || exit 1
          echo "✓ Version format is correct"

  posix-compliance:
    name: POSIX Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for bash-specific syntax
        run: |
          echo "Checking for common bashisms..."

          # Check for == in test conditions (should be =)
          if grep -n '\[ .*==.*\]' update-adguardhome.sh; then
            echo "❌ Found == in test condition (use = for POSIX compliance)"
            exit 1
          fi

          # Check for [[ ]] (bash-specific)
          if grep -n '\[\[' update-adguardhome.sh; then
            echo "❌ Found [[ ]] (use [ ] for POSIX compliance)"
            exit 1
          fi

          # Check for $( ) command substitution (POSIX allows this)
          echo "✓ Command substitution syntax is acceptable"

          echo "✓ No bashisms detected"

  log-function-tests:
    name: Log Function Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test log function output
        run: |
          # Create a test script that sources the functions
          cat > test_log.sh << 'EOF'
          #!/bin/sh
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[0;33m'
          INFO='\033[0m'

          # Source the log function from the main script
          eval "$(sed -n '/^log() {/,/^}/p' update-adguardhome.sh)"

          # Test different log levels
          output=$(log "SUCCESS" "Test message")
          echo "$output" | grep -q "✓" || exit 1
          echo "✓ SUCCESS log works"

          output=$(log "ERROR" "Test message")
          echo "$output" | grep -q "x" || exit 1
          echo "✓ ERROR log works"

          output=$(log "WARNING" "Test message")
          echo "$output" | grep -q "!" || exit 1
          echo "✓ WARNING log works"

          output=$(log "INFO" "Test message")
          echo "$output" | grep -q "→" || exit 1
          echo "✓ INFO log works"
          EOF

          chmod +x test_log.sh
          sh test_log.sh

      - name: Test timestamp functionality
        run: |
          cat > test_timestamp.sh << 'EOF'
          #!/bin/sh
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[0;33m'
          INFO='\033[0m'

          eval "$(sed -n '/^log() {/,/^}/p' update-adguardhome.sh)"

          # Test with timestamps
          output=$(log "INFO" "Test message")
          echo "$output" | grep -q "\[20[0-9][0-9]-[0-9][0-9]-[0-9][0-9]" || exit 1
          echo "✓ Timestamp format works"
          EOF

          chmod +x test_timestamp.sh
          sh test_timestamp.sh

  readme-consistency:
    name: README Consistency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if flags are documented
        run: |
          echo "Checking if all flags are documented in README..."

          # Extract flags from the script
          script_flags=$(grep -o '\--[a-z-]*' update-adguardhome.sh | sort -u)

          # Check each flag is in README
          for flag in $script_flags; do
            if ! grep -q -- "$flag" readme.md; then
              echo "❌ Flag $flag not found in README"
              exit 1
            fi
          done

          echo "✓ All flags are documented in README"

      - name: Check version badge consistency
        run: |
          script_version=$(grep 'SCRIPT_VERSION=' update-adguardhome.sh | head -1 | cut -d'"' -f2)

          # Check if version exists in readme
          if ! grep -q "$script_version" readme.md; then
            echo "⚠️  Version $script_version not found in README (may need manual update)"
          else
            echo "✓ Version is mentioned in README ($script_version)"
          fi
